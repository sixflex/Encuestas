{% extends "base.html" %}

{% block title %}
  {% if modo == 'crear' %}Crear Encuesta{% else %}Editar Encuesta{% endif %}
{% endblock %}

{% block content %}
<h1>{% if modo == 'crear' %}Crear Nueva Encuesta{% else %}Editar Encuesta{% endif %}</h1>

<form method="post">
  {% csrf_token %}

  <fieldset>
    <legend>Información de la Encuesta</legend>
    {{ form.as_p }}
    {# form incluye tipo_incidencia, titulo, descripcion, ubicacion, prioridad, departamento, estado #}
  </fieldset>

  <hr>

  <fieldset>
    <legend>Preguntas</legend>

    {{ formset.management_form }}
    <table border="1" cellpadding="6" cellspacing="0">
      <thead>
        <tr>
          <th>Pregunta</th>
          <th>Tipo</th>
          <th>Descripción</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody id="encuesta-questions">
        {% for f in formset %}
        <tr class="form-row">
          <td>{{ f.texto_pregunta }}</td>
          <td>{{ f.tipo }}</td>
          <td>{{ f.descripcion }}</td>
          <td>
            <input type="checkbox" name="{{ f.prefix }}-DELETE">
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button id="add-q" type="button">+ Agregar pregunta</button>
  </fieldset>

  <p style="margin-top:10px">
    <a href="{% url 'territorial_app:encuestas_lista' %}">Cancelar</a>
    <button type="submit">
      {% if modo == 'crear' %}Crear Encuesta{% else %}Guardar Cambios{% endif %}
    </button>
  </p>
</form>

<template id="empty-question">
  <tr class="form-row">
    <td><input type="text" name="__NAME__-texto_pregunta" maxlength="200" required></td>
    <td>
      <select name="__NAME__-tipo">
        <option value="texto">Texto</option>
        <option value="numero">Número</option>
        <option value="opcion">Opción</option>
        <option value="fecha">Fecha</option>
      </select>
    </td>
    <td><textarea name="__NAME__-descripcion" rows="2"></textarea></td>
    <td><input type="checkbox" name="__NAME__-DELETE"></td>
  </tr>
</template>

{% block extrajs %}
<script>
(function(){
  // Botón para añadir filas al formset de preguntas
  const addBtn = document.getElementById('add-q');
  if(addBtn){
    const tbody = document.getElementById('encuesta-questions');
    const tmpl = document.getElementById('empty-question').innerHTML.trim();
    const total = document.querySelector('input[name$="TOTAL_FORMS"]');

    addBtn.addEventListener('click', function(){
      const idx = parseInt(total.value || "0", 10);
      // El name base del formset puede tener prefix, p.ej. "p-"
      const prefix = (total.name || '').replace('TOTAL_FORMS','');
      const nameBase = prefix + idx;
      const html = tmpl.replaceAll('__NAME__', nameBase);
      tbody.insertAdjacentHTML('beforeend', html);
      total.value = idx + 1;
    });
  }

  // Al cambiar el tipo en modo "crear", recargar con ?tipo=<id> para precargar defaults
  {% if modo == 'crear' %}
  const tipoSelect = document.getElementById('{{ form.tipo_incidencia.id_for_label }}');
  if (tipoSelect) {
    tipoSelect.addEventListener('change', function(){
      const url = new URL(window.location.href);
      url.searchParams.set('tipo', this.value);
      window.location = url.toString();
    });
  }
  {% endif %}
})();
</script>
{% endblock %}
{% endblock %}
  {% if modo == 'crear' %}
    Crear Encuesta
  {% else %}
    Editar Encuesta
  {% endif %}
{% endblock %}

{% block content %}
<div class="container">
  <h1>
    {% if modo == 'crear' %}
       Crear Nueva Encuesta
    {% else %}
       Editar Encuesta
    {% endif %}
  </h1>

  {% if modo == 'editar' and encuesta.estado %}
    <div style="background-color: #fff3cd; padding: 10px; border: 1px solid #ffc107; margin-bottom: 15px;">
      <strong>Advertencia:</strong> No se puede editar una encuesta activa. Debes bloquearla primero.
      <form method="post" action="{% url 'territorial_app:encuesta_toggle_estado' encuesta.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" style="background: #ffc107; border: none; padding: 5px 10px; cursor: pointer;">
           Bloquear Encuesta
        </button>
      </form>
    </div>
  {% endif %}

  <hr>

  <form method="post" action="">
    {% csrf_token %}

    <fieldset>
      <legend>Información de la Encuesta</legend>

      <!-- Título -->
      <div style="margin-bottom: 15px;">
        <label for="{{ form.titulo.id_for_label }}">{{ form.titulo.label }}:</label>
        {{ form.titulo }}
        {% if form.titulo.errors %}
          <div style="color: red;">{{ form.titulo.errors }}</div>
        {% endif %}
        {% if form.titulo.help_text %}
          <small>{{ form.titulo.help_text }}</small>
        {% endif %}
      </div>

      <!-- Descripción -->
      <div style="margin-bottom: 15px;">
        <label for="{{ form.descripcion.id_for_label }}">{{ form.descripcion.label }}:</label>
        {{ form.descripcion }}
        {% if form.descripcion.errors %}
          <div style="color: red;">{{ form.descripcion.errors }}</div>
        {% endif %}
        {% if form.descripcion.help_text %}
          <small>{{ form.descripcion.help_text }}</small>
        {% endif %}
      </div>

      <!-- Ubicación -->
      <div style="margin-bottom: 15px;">
        <label for="{{ form.ubicacion.id_for_label }}">{{ form.ubicacion.label }}:</label>
        {{ form.ubicacion }}
        {% if form.ubicacion.errors %}
          <div style="color: red;">{{ form.ubicacion.errors }}</div>
        {% endif %}
        {% if form.ubicacion.help_text %}
          <small>{{ form.ubicacion.help_text }}</small>
        {% endif %}
      </div>

      <!-- Prioridad -->
      <div style="margin-bottom: 15px;">
        <label for="{{ form.prioridad.id_for_label }}">{{ form.prioridad.label }}:</label>
        {{ form.prioridad }}
        {% if form.prioridad.errors %}
          <div style="color: red;">{{ form.prioridad.errors }}</div>
        {% endif %}
        {% if form.prioridad.help_text %}
          <small>{{ form.prioridad.help_text }}</small>
        {% endif %}
      </div>

      <!-- Departamento -->
      <div style="margin-bottom: 15px;">
        <label for="{{ form.departamento.id_for_label }}">{{ form.departamento.label }}:</label>
        {{ form.departamento }}
        {% if form.departamento.errors %}
          <div style="color: red;">{{ form.departamento.errors }}</div>
        {% endif %}
        {% if form.departamento.help_text %}
          <small>{{ form.departamento.help_text }}</small>
        {% endif %}
      </div>

      <!-- Estado (Activa) -->
      <div style="margin-bottom: 15px;">
        {{ form.estado }}
        <label for="{{ form.estado.id_for_label }}">{{ form.estado.label }}</label>
        {% if form.estado.errors %}
          <div style="color: red;">{{ form.estado.errors }}</div>
        {% endif %}
        {% if form.estado.help_text %}
          <small style="display: block;">{{ form.estado.help_text }}</small>
        {% endif %}
      </div>
    </fieldset>

    <hr>

    <!-- Errores generales del formulario -->
    {% if form.non_field_errors %}
      <div style="background-color: #f8d7da; padding: 10px; border: 1px solid #f5c6cb; margin-bottom: 15px;">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <!-- Botones de acción -->
    <div>
      <button type="submit" style="background: #28a745; color: white; padding: 10px 20px; border: none; cursor: pointer;">
        {% if modo == 'crear' %}
          Crear Encuesta
        {% else %}
         Guardar Cambios
        {% endif %}
      </button>
      <a href="{% url 'territorial_app:encuestas_lista' %}" style="margin-left: 10px;">Cancelar</a>
    </div>
  </form>

  <hr>
  <p><a href="{% url 'territorial_app:encuestas_lista' %}">Volver al listado</a></p>
</div>
{% endblock %}
