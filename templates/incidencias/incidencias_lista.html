{% extends "base.html" %}
<<<<<<< HEAD
{% load auth_extras %}

{% block title %}Panel Territorial - Incidencias{% endblock %}

{% block content %}
<div class="container">
  <h1>Panel Territorial</h1>
  <p>Bienvenido. AquÃ­ puedes monitorear el trabajo en terreno y coordinar con jefes de cuadrilla.</p>
=======

{% block title %}Panel Incidencias{% endblock %}

{% block content %}
<div class="container">
  <h1>Panel incidencias</h1>
  <p>Bienvenido. AquÃ­ puedes gestionar incidencias.</p>
>>>>>>> 57b9c8f85e4d82613d934e94c986dca7655e2f87

  <hr>
  <h3>GestiÃ³n de Incidencias</h3>

  <!-- Filtros y busqueda -->
  <form method="get" class="mb-3 d-flex gap-2 align-items-center">
    <input type="text" name="q" placeholder="Buscar por tÃ­tulo" value="{{ q }}" class="form-control" style="max-width:320px;">

    <select name="estado" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
      <option value="">-- Todos los estados --</option>
      <option value="pendiente"   {% if estado_seleccionado == 'pendiente' %}selected{% endif %}>Pendiente</option>
      <option value="en_proceso"  {% if estado_seleccionado == 'en_proceso' %}selected{% endif %}>En proceso</option>
      <option value="resuelto"    {% if estado_seleccionado == 'resuelto' %}selected{% endif %}>Resuelto</option>
    </select>

    <!-- Filtro por departamento -->
    <select name="departamento" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
      <option value="">-- Todos los departamentos --</option>
      {% for depto in departamentos %}
        <option value="{{ depto.id }}" {% if departamento_seleccionado == depto.id|stringformat:"s" %}selected{% endif %}>
          {{ depto.nombre_departamento }}
        </option>
      {% endfor %}
    </select>

    <button type="submit" class="btn btn-primary">Buscar</button>
<<<<<<< HEAD
    <a href="{% url 'incidencias:incidencia_crear' %}" class="btn btn-success ms-2">â• Nueva Incidencia</a>
=======
>>>>>>> 57b9c8f85e4d82613d934e94c986dca7655e2f87
  </form>

  <p class="text-muted" style="margin-top:-6px;">
    Mostrando {{ incidencias|length }} incidencia{% if incidencias|length != 1 %}s{% endif %}
    {% if q %} con bÃºsqueda "<strong>{{ q }}</strong>"{% endif %}
    {% if estado_seleccionado %} y estado <strong>{{ estado_seleccionado }}</strong>{% endif %}
    {% if departamento_seleccionado %} en el departamento <strong>{{ departamento_nombre }}</strong>{% endif %}.
  </p>

  <!-- Tabla de incidencias -->
  <table class="table table-striped align-middle mt-3">
    <thead>
      <tr>
        <th>ID</th>
        <th>TÃ­tulo</th>
        <th>Estado</th>
        <th>Prioridad</th>
        <th>Departamento</th>
        <th>Cuadrilla</th>
        <th>Fecha de cierre</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for incidencia in incidencias %}
        <tr>
          <td>{{ incidencia.id }}</td>
          <td>{{ incidencia.titulo }}</td>
          <td>
            {% if incidencia.estado == 'pendiente' %}
              <span class="badge bg-secondary">Pendiente</span>
            {% elif incidencia.estado == 'en_proceso' %}
              <span class="badge bg-warning text-dark">En proceso</span>
<<<<<<< HEAD
            {% elif incidencia.estado == 'finalizada' %}
              <span class="badge bg-success">Finalizada</span>
            {% elif incidencia.estado == 'validada' %}
              <span class="badge bg-info">Validada</span>
            {% elif incidencia.estado == 'rechazada' %}
              <span class="badge bg-danger">Rechazada</span>
=======
            {% elif incidencia.estado == 'resuelto' %}
              <span class="badge bg-success">Resuelto</span>
>>>>>>> 57b9c8f85e4d82613d934e94c986dca7655e2f87
            {% else %}
              {{ incidencia.estado }}
            {% endif %}
          </td>
          <td>{{ incidencia.prioridad }}</td>
          <td>{{ incidencia.departamento.nombre_departamento }}</td>
          <td>
            {% if incidencia.cuadrilla %}
              {{ incidencia.cuadrilla.nombre_cuadrilla }}
            {% else %}
              Sin asignar
            {% endif %}
          </td>
          <td>
            {% if incidencia.fecha_cierre %}
              {{ incidencia.fecha_cierre|date:"d/m/Y H:i" }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="d-flex gap-2">
<<<<<<< HEAD
            <a href="{% url 'incidencias:incidencia_detalle' incidencia.id %}" class="btn btn-sm btn-primary">ğŸ‘ï¸ Ver</a>
            {% if incidencia.estado == 'pendiente' or incidencia.estado == 'en_proceso' %}
              {% if user.is_superuser %}
                <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info">âœï¸ Editar</a>
              {% elif 'Administrador' in user.groups.values_list.name %}
                <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info">âœï¸ Editar</a>
              {% elif 'Jefe de Cuadrilla' in user.groups.values_list.name %}
                <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info">âœï¸ Editar</a>
              {% endif %}
            {% endif %}
            {% if incidencia.estado == 'en_proceso' and incidencia.cuadrilla %}
              {% if user.is_superuser or user|has_group:"Administrador" or user|has_group:"Jefe de Cuadrilla" or user|has_group:"Cuadrilla" %}
                <a href="{% url 'incidencias:subir_evidencia' incidencia.id %}" class="btn btn-sm btn-success">ğŸ“¤ Subir evidencia</a>
              {% endif %}
              
              <!-- BotÃ³n finalizar si ya tiene evidencias -->
              {% if incidencia.multimedias.exists %}
                {% if user.is_superuser or user|has_group:"Administrador" or user|has_group:"Jefe de Cuadrilla" or user|has_group:"Cuadrilla" %}
                  <a href="{% url 'incidencias:finalizar_incidencia' incidencia.id %}" class="btn btn-sm btn-primary" onclick="return confirm('Â¿Finalizar esta incidencia?')">âœ… Finalizar</a>
                {% endif %}
              {% endif %}
            {% endif %}
            {% if 'Territorial' in user.groups.values_list.name %}
              {% if incidencia.estado == 'pendiente' or incidencia.estado == 'en_proceso' %}
                <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn btn-sm btn-success">âœ… Validar</a>
                <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger">âŒ Rechazar</a>
                <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">ğŸ”„ Reasignar</a>
              {% endif %}
=======
                <!--  Acciones comunes: todos pueden ver el detalle -->
              <a href="{% url 'incidencias:incidencia_detalle' incidencia.id %}" class="btn btn-sm btn-secondary">ğŸ‘ï¸ Ver</a>

    <!-- Acciones para Administrador-->
            {% if is_admin  %}
            <a href="{% url 'incidencias:incidencia_crear' %}" class="btn btn-success ms-2">â• Nueva Incidencia</a>
            <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info">âœï¸ Editar</a>
            <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn btn-sm btn-success">âœ… Validar</a>
            <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger">âŒ Rechazar</a>
            <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">ğŸ”„ Reasignar</a>
            
            {% endif %}

     <!-- Acciones para departamento -->
            {% if is_departamento %}
              <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger">âŒ Rechazar</a>
              <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">ğŸ”„ Reasignar</a>
            {% endif %}

      <!--  Acciones para  Territorial -->
            {% if is_territorial %}
            <a href="{% url 'incidencias:incidencia_crear' %}" class="btn btn-success ms-2">â• Nueva Incidencia</a>
            <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info">âœï¸ Editar</a>
            <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn btn-sm btn-success">âœ… Validar</a>
            <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">ğŸ”„ Reasignar</a>
            {% endif %}

      <!--  Acciones para Jefe de Cuadrilla -->
            {% if is_jefe %}
            <a href="{% url 'territorial_app:finalizar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">ğŸ”„ Finalizar</a>
>>>>>>> 57b9c8f85e4d82613d934e94c986dca7655e2f87
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8">No hay incidencias asignadas.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
