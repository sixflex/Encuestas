{% extends "main_base.html" %}
{% load auth_extras %}

{% block title %}Panel de Incidencias | Gestión Municipal{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
  <h1 class="h3 mb-4">Panel de Incidencias</h1>

  <!-- FILTROS -->
  <div class="card shadow-sm border-0 rounded-3 mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">

        <div class="col-md-3">
          <label for="id_q" class="form-label">Buscar</label>
          <input type="text" name="q" id="id_q" placeholder="Buscar por título" value="{{ q }}" class="form-control form-control-sm">
        </div>

        <div class="col-md-2">
          <label for="id_estado" class="form-label">Estado</label>
          <select name="estado" id="id_estado" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">-- Todos --</option>
            <option value="Pendiente" {% if estado_seleccionado == 'Pendiente' %}selected{% endif %}>Pendiente</option>
            <option value="En Progreso" {% if estado_seleccionado == 'En Progreso' %}selected{% endif %}>En Progreso</option>
            <option value="Completada" {% if estado_seleccionado == 'Completada' %}selected{% endif %}>Completada</option>
            <option value="Validada" {% if estado_seleccionado == 'Validada' %}selected{% endif %}>Validada</option>
            <option value="Rechazada" {% if estado_seleccionado == 'Rechazada' %}selected{% endif %}>Rechazada</option>
          </select>
        </div>

        <div class="col-md-2">
          <label for="id_departamento" class="form-label">Departamento</label>
          <select name="departamento" id="id_departamento" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">-- Todos --</option>
            {% for depto in departamentos %}
              <option value="{{ depto.id }}" {% if departamento_seleccionado == depto.id|stringformat:"s" %}selected{% endif %}>
                {{ depto.nombre_departamento }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <label for="id_tipo" class="form-label">Tipo</label>
          <select name="tipo_id" id="id_tipo" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">-- Todos --</option>
            {% for tipo in tipos %}
              <option value="{{ tipo.id }}" {% if tipo_seleccionado == tipo.id|stringformat:"s" %}selected{% endif %}>
                {{ tipo.nombre_problema }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-auto">
          <button type="submit" class="btn btn-primary btn-sm">Buscar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Botón crear incidencia -->
  {% if is_admin or is_territorial %}
  <div class="mb-3">
    <a href="{% url 'incidencias:incidencia_crear' %}" class="btn btn-success">
      <i class="bi bi-plus-lg"></i> Nueva Incidencia
    </a>
  </div>
  {% endif %}

  <!-- TABLA -->
  <div class="card shadow-sm border-0 rounded-3">
    <div class="card-body">

      <p class="text-muted small">
        Mostrando {{ incidencias|length }} incidencia{% if incidencias|length != 1 %}s{% endif %}
        {% if q %} con "<strong>{{ q }}</strong>"{% endif %}
        {% if estado_seleccionado %} en estado <strong>{{ estado_seleccionado }}</strong>{% endif %}
        {% if departamento_seleccionado %} del departamento <strong>{{ departamento_nombre }}</strong>{% endif %}.
      </p>

      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mt-2">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Título</th>
              <th>Estado</th>
              <th>Prioridad</th>
              <th>Departamento</th>
              <th>Tipo de Incidencia</th>
              <th>Cuadrilla</th>
              <th>Fecha de cierre</th>
              <th style="min-width:260px;">Acciones</th>
            </tr>
          </thead>

          <tbody>
            {% for incidencia in incidencias %}
            <tr>
              <td>{{ incidencia.id }}</td>
              <td>{{ incidencia.titulo }}</td>

              <!-- ESTADOS -->
              <td>
                {% if incidencia.estado == 'pendiente' %}
                  <span class="badge bg-secondary">Pendiente</span>
                {% elif incidencia.estado == 'en_progreso' %}
                  <span class="badge bg-warning text-dark">En progreso</span>
                {% elif incidencia.estado == 'completada' %}
                  <span class="badge bg-success">Completada</span>
                {% elif incidencia.estado == 'validada' %}
                  <span class="badge bg-info">Validada</span>
                {% elif incidencia.estado == 'rechazada' %}
                  <span class="badge bg-danger">Rechazada</span>
                {% else %}
                  {{ incidencia.estado }}
                {% endif %}
              </td>

              <td>{{ incidencia.prioridad }}</td>
              <td>{{ incidencia.departamento.nombre_departamento }}</td>

              <!-- TIPO DE INCIDENCIA -->
              <td>
                {% if incidencia.encuesta and incidencia.encuesta.tipo_incidencia %}
                  {{ incidencia.encuesta.tipo_incidencia }}
                {% else %}
                  <span class="text-muted">No asignado</span>
                {% endif %}
              </td>

              <td>
                {% if incidencia.cuadrilla %}
                  {{ incidencia.cuadrilla.nombre_cuadrilla }}
                {% else %}
                  <span class="text-muted">Sin asignar</span>
                {% endif %}
              </td>

              <td>
                {% if incidencia.fecha_cierre %}
                  {{ incidencia.fecha_cierre|date:"d/m/Y H:i" }}
                {% else %}
                  -
                {% endif %}
              </td>

              <!-- ACCIONES CON BOTONES ALINEADOS -->
              <td>
                <div class="d-flex gap-2" style="flex-wrap:nowrap; overflow-x:auto; min-width:260px; align-items:center;">
                <!-- Ver -->
                  <a href="{% url 'incidencias:incidencia_detalle' incidencia.id %}" class="btn btn-sm btn-secondary">Ver</a>

                  {% if is_admin %}
                    <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info">Editar</a>
                    <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn btn-sm btn-success">Validar</a>
                    <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger">Rechazar</a>
                    <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">Reasignar</a>
                  {% endif %}

                {% if is_departamento %}
                  <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger">Rechazar</a>
                  <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">Asignar Cuadrilla</a>
                {% endif %}

                {% if is_territorial %}
                  <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info">Editar</a>
                  <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn btn-sm btn-success">Validar</a>
                  <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger">Rechazar</a>
                  <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">Reasignar</a>

                  {% if incidencia.encuesta %}
                    <a href="{% url 'territorial_app:responder_encuesta' incidencia.encuesta.id incidencia.id %}" class="btn btn-sm btn-outline-primary">
                      Responder encuesta
                    </a>
                  {% endif %}
                {% endif %}

                {% if is_jefe and incidencia.encuesta %}
                  <a href="{% url 'territorial_app:finalizar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">Completar</a>
                  <a href="{% url 'territorial_app:responder_encuesta' incidencia.encuesta.id incidencia.id %}" class="btn btn-sm btn-outline-primary">Responder encuesta</a>
                {% endif %}

                {% if incidencia.estado == 'en_progreso' and incidencia.cuadrilla %}
                  {% if user.is_superuser or is_admin or is_jefe %}
                    <a href="{% url 'incidencias:subir_evidencia' incidencia.id %}" class="btn btn-sm btn-success">Subir evidencia</a>

                    {% if incidencia.multimedias.exists %}
                      <a href="{% url 'territorial_app:finalizar_incidencia' incidencia.id %}" class="btn btn-sm btn-primary" onclick="return confirm('¿Finalizar esta incidencia?')">Finalizar</a>
                    {% endif %}
                  {% endif %}
                {% endif %}

              </td>
            </tr>
            {% empty %}
            <tr><td colspan="9" class="text-center">No hay incidencias asignadas.</td></tr>
            {% endfor %}
          </tbody>

        </table>
      </div>

    </div>
  </div>

</div>
{% endblock %}
