{% extends "base.html" %}

{% block title %}Panel Territorial - Incidencias{% endblock %}

{% block content %}
<div class="container">
  <h1>Panel Territorial</h1>
  <p>Bienvenido. Aqu√≠ puedes monitorear el trabajo en terreno y coordinar con jefes de cuadrilla.</p>

  <hr>
  <h3>Gesti√≥n de Incidencias</h3>

  <!-- Filtros y busqueda -->
  <form method="get" class="mb-3 d-flex gap-2 align-items-center">
    <input type="text" name="q" placeholder="Buscar por t√≠tulo" value="{{ q }}" class="form-control" style="max-width:320px;">

    <select name="estado" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
      <option value="">-- Todos los estados --</option>
      <option value="pendiente"   {% if estado_seleccionado == 'pendiente' %}selected{% endif %}>Pendiente</option>
      <option value="en_proceso"  {% if estado_seleccionado == 'en_proceso' %}selected{% endif %}>En proceso</option>
      <option value="resuelto"    {% if estado_seleccionado == 'resuelto' %}selected{% endif %}>Resuelto</option>
    </select>

    <!-- Filtro por departamento -->
    <select name="departamento" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
      <option value="">-- Todos los departamentos --</option>
      {% for depto in departamentos %}
        <option value="{{ depto.id }}" {% if departamento_seleccionado == depto.id|stringformat:"s" %}selected{% endif %}>
          {{ depto.nombre_departamento }}
        </option>
      {% endfor %}
    </select>

    <button type="submit" class="btn btn-primary">Buscar</button>
    <a href="{% url 'incidencias:incidencia_crear' %}" class="btn btn-success ms-2">‚ûï Nueva Incidencia</a>
  </form>

  <p class="text-muted" style="margin-top:-6px;">
    Mostrando {{ incidencias|length }} incidencia{% if incidencias|length != 1 %}s{% endif %}
    {% if q %} con b√∫squeda "<strong>{{ q }}</strong>"{% endif %}
    {% if estado_seleccionado %} y estado <strong>{{ estado_seleccionado }}</strong>{% endif %}
    {% if departamento_seleccionado %} en el departamento <strong>{{ departamento_nombre }}</strong>{% endif %}.
  </p>

  <!-- Tabla de incidencias -->
  <table class="table table-striped align-middle mt-3">
    <thead>
      <tr>
        <th>ID</th>
        <th>T√≠tulo</th>
        <th>Estado</th>
        <th>Prioridad</th>
        <th>Departamento</th>
        <th>Cuadrilla</th>
        <th>Fecha de cierre</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for incidencia in incidencias %}
        <tr>
          <td>{{ incidencia.id }}</td>
          <td>{{ incidencia.titulo }}</td>
          <td>
            {% if incidencia.estado == 'pendiente' %}
              <span class="badge bg-secondary">Pendiente</span>
            {% elif incidencia.estado == 'en_proceso' %}
              <span class="badge bg-warning text-dark">En proceso</span>
            {% elif incidencia.estado == 'resuelto' %}
              <span class="badge bg-success">Resuelto</span>
            {% else %}
              {{ incidencia.estado }}
            {% endif %}
          </td>
          <td>{{ incidencia.prioridad }}</td>
          <td>{{ incidencia.departamento.nombre_departamento }}</td>
          <td>
            {% if incidencia.cuadrilla %}
              {{ incidencia.cuadrilla.nombre_cuadrilla }}
            {% else %}
              Sin asignar
            {% endif %}
          </td>
          <td>
            {% if incidencia.fecha_cierre %}
              {{ incidencia.fecha_cierre|date:"d/m/Y H:i" }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="d-flex gap-2">
            <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info">‚úèÔ∏è Editar</a>
            <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn btn-sm btn-success">‚úÖ Validar</a>
            <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger">‚ùå Rechazar</a>
            <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">üîÑ Reasignar</a>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8">No hay incidencias asignadas.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
