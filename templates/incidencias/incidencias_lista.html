{% extends "base.html" %}
{% load static %}
{% block content %}
<h2>Lista de Incidencias</h2>

<form method="get" class="mb-3 d-flex gap-2" style="align-items:center;">
  <input type="text" name="q" placeholder="Buscar por título" value="{{ q }}" class="form-control" style="max-width:320px;">
  <select name="estado" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
    <option value="">-- Todos los estados --</option>
    <option value="pendiente"   {% if estado_seleccionado == 'pendiente' %}selected{% endif %}>Pendiente</option>
    <option value="en_proceso"  {% if estado_seleccionado == 'en_proceso' %}selected{% endif %}>En proceso</option>
    <option value="resuelto"    {% if estado_seleccionado == 'resuelto' %}selected{% endif %}>Resuelto</option>
  </select>
  <button type="submit" class="btn btn-primary">Buscar</button>
  {% if perms.core.add_incidencia %}
    <a href="{% url 'incidencias:incidencia_crear' %}" class="btn btn-success">+ Nueva</a>
  {% endif %}
</form>

<p class="text-muted" style="margin-top:-6px;">
  Mostrando {{ incidencias|length }} incidencia{% if incidencias|length != 1 %}s{% endif %}
  {% if q %} con búsqueda "<strong>{{ q }}</strong>"{% endif %}
  {% if estado_seleccionado %} y estado <strong>{{ estado_seleccionado }}</strong>{% endif %}.
</p>

<table class="table table-striped align-middle">
  <thead>
    <tr>
      <th>Título</th>
      <th>Estado</th>
      <th>Prioridad</th>
      <th>Departamento</th>
      <th>Creado el</th>
      <th style="width:210px;">Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for incidencia in incidencias %}
      <tr>
        <td>{{ incidencia.titulo }}</td>
        <td>
          {% if incidencia.estado == 'pendiente' %}
            <span class="badge bg-secondary">Pendiente</span>
          {% elif incidencia.estado == 'en_proceso' %}
            <span class="badge bg-warning text-dark">En proceso</span>
          {% elif incidencia.estado == 'resuelto' %}
            <span class="badge bg-success">Resuelto</span>
          {% else %}
            {{ incidencia.estado }}
          {% endif %}
        </td>
        <td>{{ incidencia.prioridad }}</td>
        <td>{{ incidencia.departamento }}</td>
        <td>{{ incidencia.creadoEl|date:"d/m/Y H:i" }}</td>
        <td class="d-flex gap-2">
          <a href="{% url 'incidencias:incidencia_detalle' incidencia.pk %}" class="btn btn-sm btn-info">Ver</a>

          {% if perms.core.change_incidencia %}
            <a href="{% url 'incidencias:incidencia_editar' incidencia.pk %}" class="btn btn-sm btn-warning">Editar</a>
          {% endif %}

          {% if perms.core.delete_incidencia %}
            <a href="{% url 'incidencias:incidencia_eliminar' incidencia.pk %}" class="btn btn-sm btn-danger">Eliminar</a>
          {% endif %}
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="6">No hay incidencias registradas.</td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
