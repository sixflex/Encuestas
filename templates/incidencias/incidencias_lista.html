{% extends "base.html" %}

{% block title %}Panel Incidencias{% endblock %}

{% block content %}
<div class="container">
  <h1>Panel incidencias</h1>
  <p>Bienvenido. Aquí puedes gestionar incidencias.</p>

  <hr>
  <h3>Gestión de Incidencias</h3>

  <!-- Filtros y busqueda -->
  <form method="get" class="mb-3 d-flex gap-2 align-items-center">
    <input type="text" name="q" placeholder="Buscar por título" value="{{ q }}" class="form-control" style="max-width:320px;">

    <select name="estado" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
      <option value="">-- Todos los estados --</option>
      <option value="pendiente"   {% if estado_seleccionado == 'pendiente' %}selected{% endif %}>Pendiente</option>
      <option value="en_proceso"  {% if estado_seleccionado == 'en_proceso' %}selected{% endif %}>En proceso</option>
      <option value="resuelto"    {% if estado_seleccionado == 'resuelto' %}selected{% endif %}>Resuelto</option>
    </select>

    <!-- Filtro por departamento -->
    <select name="departamento" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
      <option value="">-- Todos los departamentos --</option>
      {% for depto in departamentos %}
        <option value="{{ depto.id }}" {% if departamento_seleccionado == depto.id|stringformat:"s" %}selected{% endif %}>
          {{ depto.nombre_departamento }}
        </option>
      {% endfor %}
    </select>

    <button type="submit" class="btn btn-primary">Buscar</button>
  </form>

  <p class="text-muted" style="margin-top:-6px;">
    Mostrando {{ incidencias|length }} incidencia{% if incidencias|length != 1 %}s{% endif %}
    {% if q %} con búsqueda "<strong>{{ q }}</strong>"{% endif %}
    {% if estado_seleccionado %} y estado <strong>{{ estado_seleccionado }}</strong>{% endif %}
    {% if departamento_seleccionado %} en el departamento <strong>{{ departamento_nombre }}</strong>{% endif %}.
  </p>

  <!-- Tabla de incidencias -->
  <table class="table table-striped align-middle mt-3">
    <thead>
      <tr>
        <th>ID</th>
        <th>Título</th>
        <th>Estado</th>
        <th>Prioridad</th>
        <th>Departamento</th>
        <th>Cuadrilla</th>
        <th>Fecha de cierre</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for incidencia in incidencias %}
        <tr>
          <td>{{ incidencia.id }}</td>
          <td>{{ incidencia.titulo }}</td>
          <td>
            {% if incidencia.estado == 'pendiente' %}
              <span class="badge bg-secondary">Pendiente</span>
            {% elif incidencia.estado == 'en_proceso' %}
              <span class="badge bg-warning text-dark">En proceso</span>
            {% elif incidencia.estado == 'resuelto' %}
              <span class="badge bg-success">Resuelto</span>
            {% else %}
              {{ incidencia.estado }}
            {% endif %}
          </td>
          <td>{{ incidencia.prioridad }}</td>
          <td>{{ incidencia.departamento.nombre_departamento }}</td>
          <td>
            {% if incidencia.cuadrilla %}
              {{ incidencia.cuadrilla.nombre_cuadrilla }}
            {% else %}
              Sin asignar
            {% endif %}
          </td>
          <td>
            {% if incidencia.fecha_cierre %}
              {{ incidencia.fecha_cierre|date:"d/m/Y H:i" }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="d-flex gap-2">
                <!--  Acciones comunes: todos pueden ver el detalle -->
              <a href="{% url 'incidencias:incidencia_detalle' incidencia.id %}" class="btn btn-sm btn-secondary">👁️ Ver</a>

    <!-- Acciones para Administrador-->
            {% if is_admin  %}
            <a href="{% url 'incidencias:incidencia_crear' %}" class="btn btn-success ms-2">➕ Nueva Incidencia</a>
            <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info">✏️ Editar</a>
            <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn btn-sm btn-success">✅ Validar</a>
            <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger">❌ Rechazar</a>
            <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">🔄 Reasignar</a>
            
            {% endif %}

     <!-- Acciones para departamento -->
            {% if is_departamento %}
              <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger">❌ Rechazar</a>
              <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">🔄 Reasignar</a>
            {% endif %}

      <!--  Acciones para  Territorial -->
            {% if is_territorial %}
            <a href="{% url 'incidencias:incidencia_crear' %}" class="btn btn-success ms-2">➕ Nueva Incidencia</a>
            <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info">✏️ Editar</a>
            <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn btn-sm btn-success">✅ Validar</a>
            <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">🔄 Reasignar</a>
            {% endif %}

      <!--  Acciones para Jefe de Cuadrilla -->
            {% if is_jefe %}
            <a href="{% url 'territorial_app:finalizar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">🔄 Finalizar</a>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8">No hay incidencias asignadas.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
