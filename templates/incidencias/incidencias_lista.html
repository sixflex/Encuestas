{% extends "base.html" %}

{% block title %}Panel Incidencias{% endblock %}

{% block content %}
<div class="container">
  <h1>Panel de Incidencias</h1>
  <p>Bienvenido. Aquí puedes gestionar las incidencias.</p>

  <hr>
  <h3>Gestión de Incidencias</h3>

  <!--  Filtros y búsqueda -->
  <form method="get" class="mb-3 d-flex gap-2 align-items-center">
    <input type="text" name="q" placeholder="Buscar por título" value="{{ q }}" class="form-control" style="max-width:320px;">

    <!--  Filtros y búsqueda -->
    <select name="estado" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
      <option value="">-- Todos los estados --</option>
      <option value="Pendiente" {% if estado_seleccionado == 'Pendiente' %}selected{% endif %}>Pendiente</option>
      <option value="En Progreso" {% if estado_seleccionado == 'En Progreso' %}selected{% endif %}>En Progreso</option>
      <option value="Completada" {% if estado_seleccionado == 'Completada' %}selected{% endif %}>Completada</option>
      <option value="Validada" {% if estado_seleccionado == 'Validada' %}selected{% endif %}>Validada</option>
      <option value="Rechazada" {% if estado_seleccionado == 'Rechazada' %}selected{% endif %}>Rechazada</option>
    </select>
    </select>

    <!-- Filtro por departamento -->
    <select name="departamento" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
      <option value="">-- Todos los departamentos --</option>
      {% for depto in departamentos %}
        <option value="{{ depto.id }}" {% if departamento_seleccionado == depto.id|stringformat:"s" %}selected{% endif %}>
          {{ depto.nombre_departamento }}
        </option>
      {% endfor %}
    </select>

    <!-- NUEVO Filtro por tipo de incidencia -->
    <select name="tipo" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
      <option value="">-- Todos los tipos --</option>
      {% for tipo in tipos %}
        <option value="{{ tipo.id }}" {% if tipo_seleccionado == tipo.id|stringformat:"s" %}selected{% endif %}>
          {{ tipo.nombre_problema }}
        </option>
      {% endfor %}
    </select>

    <button type="submit" class="btn btn-primary">Buscar</button>
  </form>

  <p class="text-muted" style="margin-top:-6px;">
    Mostrando {{ incidencias|length }} incidencia{% if incidencias|length != 1 %}s{% endif %}
    {% if q %} con búsqueda "<strong>{{ q }}</strong>"{% endif %}
    {% if estado_seleccionado %} y estado <strong>{{ estado_seleccionado }}</strong>{% endif %}
    {% if departamento_seleccionado %} en el departamento <strong>{{ departamento_nombre }}</strong>{% endif %}.
  </p>

  <!--  Botón para crear nueva incidencia -->
  {% if is_admin or is_territorial %}
    <div class="mb-3">
      <a href="{% url 'incidencias:incidencia_crear' %}" class="btn btn-success"> Nueva Incidencia</a>
    </div>
  {% endif %}

  <!--  Tabla de incidencias -->
  <table class="table table-striped align-middle mt-3">
    <thead>
      <tr>
        <th>ID</th>
        <th>Título</th>
        <th>Encuesta</th>
        <th>Estado</th>
        <th>Prioridad</th>
        <th>Departamento</th>
        <th>Cuadrilla</th>
        <th>Fecha de cierre</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for incidencia in incidencias %}
        <tr>
          <td>{{ incidencia.id }}</td>
          <td>{{ incidencia.titulo }}</td>
          <td>
          {% if incidencia.encuesta %}
            {{ incidencia.encuesta.titulo }}
          {% else %}
            Sin encuesta
          {% endif %}
        </td>
          <td>
            {% if incidencia.estado == 'pendiente' %}
              <span class="badge bg-secondary">Pendiente</span>
            {% elif incidencia.estado == 'en_progreso' %}
              <span class="badge bg-warning text-dark">En progreso</span>
            {% elif incidencia.estado == 'finalizada' %}
              <span class="badge bg-success">Finalizada</span>
            {% elif incidencia.estado == 'validada' %}
              <span class="badge bg-info">Validada</span>
            {% elif incidencia.estado == 'rechazada' %}
              <span class="badge bg-danger">Rechazada</span>
            {% else %}
              {{ incidencia.estado }}
            {% endif %}
          </td>
          <td>{{ incidencia.prioridad }}</td>
          <td>{{ incidencia.departamento.nombre_departamento }}</td>
          <td>
            {% if incidencia.cuadrilla %}
              {{ incidencia.cuadrilla.nombre_cuadrilla }}
            {% else %}
              Sin asignar
            {% endif %}
          </td>
          <td>
            {% if incidencia.fecha_cierre %}
              {{ incidencia.fecha_cierre|date:"d/m/Y H:i" }}
            {% else %}
              -
            {% endif %}
          </td>

          <td class="d-flex flex-wrap gap-2">

            <!--  Acción común: ver detalle -->
            <a href="{% url 'incidencias:incidencia_detalle' incidencia.id %}" class="btn btn-sm btn-secondary">Ver</a>

            <!--  Acciones para Administrador -->
            {% if is_admin %}
              <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info"> Editar</a>
              <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn btn-sm btn-success">Validar</a>
              <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger"> Rechazar</a>
              <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning"> Reasignar</a>
            {% endif %}

            <!--  Acciones para Departamento -->
            {% if is_departamento %}
              <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger"> Rechazar</a>
              <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning"> Reasignar</a>
            {% endif %}

            <!--  Acciones para Territorial -->
            {% if is_territorial %}
              <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}" class="btn btn-sm btn-info"> Editar</a>
              <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn btn-sm btn-success">Validar</a>
              <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning"> Reasignar</a>
            {% endif %}

            <!-- Acciones para Jefe de Cuadrilla -->
            {% if is_jefe %}
              <a href="{% url 'territorial_app:finalizar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning"> Finalizar</a>
            {% endif %}

            <!--  Subir evidencia y finalizar -->
            {% if incidencia.estado == 'en_proceso' and incidencia.cuadrilla %}
            {% if user.is_superuser or is_admin or is_jefe %}
                <a href="{% url 'incidencias:subir_evidencia' incidencia.id %}" class="btn btn-sm btn-success"> Subir evidencia</a>
              {% endif %}

              {% if incidencia.multimedias.exists %}
                {% if user.is_superuser or is_admin or is_jefe %}
                  <a href="{% url 'territorial:finalizar_incidencia' incidencia.id %}" class="btn btn-sm btn-primary" onclick="return confirm('¿Finalizar esta incidencia?')">✅ Finalizar</a>
                {% endif %}
              {% endif %}
            {% endif %}

            <!--  Validar/Rechazar/Reasignar para Territorial -->
            {% if user.is_territorial %}
              {% if incidencia.estado == 'pendiente' or incidencia.estado == 'en_proceso' %}
                <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn btn-sm btn-success">Validar</a>
                <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn btn-sm btn-danger">Rechazar</a>
                <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn btn-sm btn-warning">Reasignar</a>
              {% endif %}
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8">No hay incidencias asignadas.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
