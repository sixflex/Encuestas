{% extends "main_base.html" %}
{% load static %}
{% load personas_auth_extras %}

{% block title %}Dashboard Administrador | Gestión Municipal{% endblock %}

{% block dashboard_content %}
<h1 class="h3 mb-4">Panel de Administración</h1>
<p>Bienvenido, {{ request.user.username }}</p>

<!-- Tarjetas con totales -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card p-3 shadow-sm border-0 rounded-3">
            <h5 class="card-title text-muted small">Usuarios</h5>
            <p class="card-text fs-4 fw-bold">Total: {{ total_usuarios }}</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3 shadow-sm border-0 rounded-3">
            <h5 class="card-title text-muted small">Incidencias Creadas</h5>
            <p class="card-text fs-4 fw-bold">Hoy: {{ total_incidencias_creadas }}</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3 shadow-sm border-0 rounded-3">
            <h5 class="card-title text-muted small">Incidencias Finalizadas</h5>
            <p class="card-text fs-4 fw-bold">Última semana: {{ total_incidencias_finalizadas }}</p>
        </div>
    </div>
</div>

<!-- Últimos Usuarios -->
<div class="card mb-4 shadow-sm border-0 rounded-3">
    <div class="card-body">
        <h3 class="card-title border-bottom pb-2 mb-3">Últimos Usuarios</h3>
        <div class="table-responsive">
            <table class="table table-borderless table-sm">
                <thead>
                    <tr class="text-muted small">
                        <th>#</th>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Teléfono</th>
                        <th>Perfil</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in ultimos_usuarios %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ u.user.first_name }} {{ u.user.last_name }}</td>
                        <td>{{ u.user.email }}</td>
                        <td>{{ u.telefono }}</td>
                        <td>{{ u.group.name }}</td>
                        <td>
                            <a href="{% url 'personas:usuarios_lista' %}" class="btn btn-sm btn-outline-primary">Ver</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6">No hay usuarios registrados</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Últimas Direcciones -->
<div class="card mb-4 shadow-sm border-0 rounded-3">
    <div class="card-body">
        <h3 class="card-title border-bottom pb-2 mb-3">Últimas Direcciones</h3>
        {% for d in ultimas_direcciones %}
            <p class="mb-0">{{ d.nombre_direccion }} - Encargado: <strong>{{ d.encargado.user.get_full_name }}</strong></p>
        {% empty %}
            <p>No hay direcciones registradas</p>
        {% endfor %}
    </div>
</div>

<!-- Últimos Departamentos -->
<div class="card mb-4 shadow-sm border-0 rounded-3">
    <div class="card-body">
        <h3 class="card-title border-bottom pb-2 mb-3">Últimos Departamentos</h3>
        {% for dep in ultimos_departamentos %}
            <p class="mb-0">{{ dep.nombre_departamento }} - Encargado: <strong>{{ dep.encargado.user.get_full_name }}</strong></p>
        {% empty %}
            <p>No hay departamentos registrados</p>
        {% endfor %}
    </div>
</div>

<!-- Últimas Incidencias -->
<div class="card mb-4 shadow-sm border-0 rounded-3">
    <div class="card-body">
        <h3 class="card-title border-bottom pb-2 mb-3">Últimas Incidencias</h3>
        <div class="table-responsive">
            <table class="table table-borderless table-sm">
                <thead>
                    <tr class="text-muted small">
                        <th>#</th>
                        <th>Nombre</th>
                        <th>Dirección</th>
                        <th>Depto</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in ultimas_incidencias %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ i.titulo }}</td>
                        <td>
                            {% if i.departamento and i.departamento.direccion %}
                                {{ i.departamento.direccion.nombre_direccion }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if i.departamento %}
                                {{ i.departamento.nombre_departamento }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'incidencias:incidencias_lista' %}" class="btn btn-sm btn-outline-primary">Ver</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5">No hay incidencias registradas</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock dashboard_content %}
